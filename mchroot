#!/usr/bin/python3

import argparse
import configparser
import glob
import os
import subprocess

from dpkg.env import DISTROS
from dpkg.env import ARCHITECTURES
from dpkg.argparse_helpers import build_parser

parser = argparse.ArgumentParser(
    description='Execute command in multiple chroots via schroot.')

group = parser.add_argument_group('chroots', 'Chroots to execute for.')
group.add_argument('--skip-arch', '--sa', metavar='ARCH', action='append',
    choices=['i386', 'amd64'], default=[],
    help="Skip given architecture. May be given multiple times.")
group.add_argument('--skip-dist', '--sd', metavar='DIST', action='append',
    default=[], help="Skip given distribution. May be given multiple times.")
group.add_argument('--from-dist', '--fd', metavar='DIST',
    help="Only build on distributions equal or newer then DIST.")
group.add_argument('--until-dist', '--ud', metavar='DIST',
    help="Only build in distributions equal or older then DIST.")
group.add_argument(
    '--dist', '-d', metavar='DIST',
    help='Only build on the specified distribution. (Overrides --sa, --fd and --ud)')

subparsers = parser.add_subparsers(
    dest='cmd', help="subcommands",
    description='A subcommand describes an action for the specified chroots.')
build = subparsers.add_parser(
    'build', aliases=['b'], parents=[build_parser],
    help="Build the package using git-build.py.",
    description="Build the package using git-build.py. Any parameters are passed to git-build.py")
login = subparsers.add_parser(
    'login', aliases=['l'], help="Sequentially open a shell in every chroot.")
login.add_argument('--save', default=False, action='store_true')
login.add_argument('--bindmounts', help="Bind given command into the chroot.")
update = subparsers.add_parser(
    'update', aliases=['u'], help="Update chroots.")
execute = subparsers.add_parser('execute', aliases=['exec', 'e'],
    help="Execute a command in every chroot - unfortunately not yet implemented.")
execute.add_argument('script', help="The script to execute.")
execute.add_argument('--bindmounts', '--bind', '-b', help="Bind given path into the chroot.")
args = parser.parse_args()

failed = []
cwd = os.getcwd()
configpath = '/etc/dist-config'
userpath = os.path.expanduser('~/.dist-config')

cows = [os.path.basename(d) for d in glob.glob('/var/cache/pbuilder/base-*.cow')]
dists = set([c.split('-')[1] for c in cows])

# skip distributions named at the command-line:
dists = sorted([d for d in dists if d not in args.skip_dist])

# honour --from-dist/--until-dist from command-line
if args.dist:  # explicit dist from CLI
    dists = [d for d in dists if d == args.dist]
else:
    if args.from_dist:
        index = DISTROS.index(args.from_dist)
        dists = [d for d in dists if d in DISTROS and DISTROS.index(d) >= index]
    if args.until_dist:
        index = DISTROS.index(args.until_dist)
        dists = [d for d in dists if d in DISTROS and DISTROS.index(d) <= index]

# honour skip = true in .cfg file
for dist in list(dists):
    config = configparser.ConfigParser({'skip': 'false'})
    config.read([os.path.join(userpath, '%s.cfg' % dist),
                os.path.join(configpath, '%s.cfg' % dist)])
    if config.getboolean('DEFAULT', 'skip'):
        dists.remove(dist)

# honour archs:
archs = [a for a in ARCHITECTURES if a not in args.skip_arch]

# finally, loop over dists:
for dist in dists:
    for arch in archs:
        if os.path.exists('/var/cache/pbuilder/base-%s-%s.cow' % (dist, arch)):
            os.environ['DIST'] = dist
            os.environ['ARCH'] = arch

            if args.cmd == 'update':
                cmd = ['git-pbuilder', 'update', ]
            elif args.cmd == 'login':
                cmd = ['git-pbuilder', 'login', ]
                if args.save:
                    cmd.append('--save-after-login')
                if args.bindmounts:
                    cmd += ['--bindmounts', args.bindmounts]
            elif args.cmd == 'build':
                cmd = ['git-build.py', '--dist=%s' % dist, '--arch=%s' % arch]
                if args.upload:
                    cmd.append('--upload')
                if not args.pristine:
                    cmd.append('--no-pristine')

                    if args.upstream_tree:  # tree only has effect when not using pristine-tar
                        cmd.append('--upstream-tree=%s' % args.upstream_tree)
                        if args.upstream_branch:
                            cmd.append('--upstream-branch=%s' % args.upstream_branch)
            elif args.cmd == 'execute':
                basepath = '/var/cache/pbuilder/base-%s-%s.cow' % (dist, arch)
                configfile = os.path.expanduser('~/.pbuilderrc')
                cmd = ['sudo', 'cowbuilder', '--execute', args.script, '--dist', dist,
                       '--architecture', arch, '--basepath', basepath, '--configfile', configfile]
                if args.bindmounts:
                    cmd += ['--bindmounts', args.bindmounts]
            else:
                print("Error: Unknown command: %s" % args.cmd)
                continue
        else:
            print('Error: %s-%s: cow not found' % (dist, arch))
            failed.append('%s-%s' % (dist, arch))
            continue

        print('\n\n### DIST=%s ARCH=%s %s\n' % (dist, arch, ' '.join(cmd)))
        ret = subprocess.call(cmd)
        if ret > 0:
            failed.append('%s-%s' % (dist, arch))

if failed:
    print("\n\nThe command failed on the following distributions:\n\t%s" % ', '.join(failed))
